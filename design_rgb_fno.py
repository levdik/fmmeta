import numpy as np
import jax
import jax.numpy as jnp
from flax import nnx
import h5py
import pickle
import matplotlib.pyplot as plt
import matplotlib

from ai_fno import PatternToAmpsFNO
from field_postprocessing import calculate_focusing_efficiency, propagate_amps_in_free_space
from design_optimizer import run_gradient_ascent
import topology_parametrization
from scattering_simulation import prepare_lens_scattering_solver

from field_postprocessing import intensity_map_from_fourier_amplitudes
from field_plotter import plot_amplitude_map

matplotlib.use('TkAgg')
jax.config.update('jax_enable_x64', True)


def load_fno_model(model_name, **fno_kwargs):
    with open(f'ai_models/{model_name}.pkl', 'rb') as f:
        state_restored = pickle.load(f)

    model = PatternToAmpsFNO(
        **fno_kwargs,
        activation_fn=nnx.gelu,
        rngs=nnx.Rngs(0)
    )

    model.propagating_indices = state_restored.propagating_indices
    model.fno.lifting.kernel = nnx.Param(state_restored.fno.lifting.kernel.value)
    model.fno.projection.kernel = nnx.Param(state_restored.fno.projection.kernel.value)
    for i in range(len(state_restored.fno.fourier_layers)):
        model.fno.fourier_layers[i].fourier_linear_block.w_re = nnx.Param(
            state_restored.fno.fourier_layers[i].fourier_linear_block.w_re.value)
        model.fno.fourier_layers[i].fourier_linear_block.w_im = nnx.Param(
            state_restored.fno.fourier_layers[i].fourier_linear_block.w_im.value)
        model.fno.fourier_layers[i].bypass_convolution.kernel = nnx.Param(
            state_restored.fno.fourier_layers[i].bypass_convolution.kernel.value)

    return model


def rgb_amps_to_eff(red_amps, green_amps, blue_amps):
    red_amps = propagate_amps_in_free_space(red_amps, 2500, red_expansion, 650, 2000)
    green_amps = propagate_amps_in_free_space(green_amps, 2500, green_expansion, 550, 2000)
    blue_amps = propagate_amps_in_free_space(blue_amps, 2500, blue_expansion, 450, 2000)

    red_eff = calculate_focusing_efficiency(red_amps, red_expansion, relative_focal_point=(0.25, 0.25))
    green_eff = (
            calculate_focusing_efficiency(green_amps, green_expansion, relative_focal_point=(0.25, 0.75))
            + calculate_focusing_efficiency(green_amps, green_expansion, relative_focal_point=(0.75, 0.25))
    )
    blue_eff = calculate_focusing_efficiency(blue_amps, blue_expansion, relative_focal_point=(0.75, 0.75))
    # red_eff *= jnp.sum(jnp.abs(red_amps) ** 2)
    # green_eff *= jnp.sum(jnp.abs(green_amps) ** 2)
    # blue_eff *= jnp.sum(jnp.abs(blue_amps) ** 2)
    red_eff *= jnp.minimum(jnp.sum(jnp.abs(red_amps) ** 2), 1.)
    green_eff *= jnp.minimum(jnp.sum(jnp.abs(green_amps) ** 2), 1.)
    blue_eff *= jnp.minimum(jnp.sum(jnp.abs(blue_amps) ** 2), 1.)

    print(red_eff, green_eff, blue_eff)

    # return (
    #         (red_eff - 0.25) / 0.75
    #         + (green_eff - 0.5) / 0.5
    #         + (blue_eff - 0.25) / 0.75
    # ) / 3
    return (red_eff + green_eff + blue_eff) / 3


if __name__ == '__main__':
    common_fno_kwargs = {
        'hidden_n_channels': [64] * 5,
        'n_pixels': 64,
        'mode_threshold': 16
    }
    red_model = load_fno_model('fno_red', n_propagating_modes=29, **common_fno_kwargs)
    green_model = load_fno_model('fno_green', n_propagating_modes=45, **common_fno_kwargs)
    blue_model = load_fno_model('fno_blue', n_propagating_modes=61, **common_fno_kwargs)

    common_sim_kwargs = {
        'period': 2000,
        'lens_thickness': 600,
        'substrate_thickness': 500,
        'approximate_number_of_terms': 300,
        # 'propagate_by_distance': 2500
    }
    red_sim, red_expansion = prepare_lens_scattering_solver(wavelength=650, **common_sim_kwargs)
    green_sim, green_expansion = prepare_lens_scattering_solver(wavelength=550, **common_sim_kwargs)
    blue_sim, blue_expansion = prepare_lens_scattering_solver(wavelength=450, **common_sim_kwargs)

    # topology = topology_parametrization.FourierInterpolation(grid_size=10, symmetry_type='main_diagonal')
    topology = topology_parametrization.FourierExpansion(7, 'main_diagonal')

    def predicted_total_eff(x):
        pattern = topology(x, 64)
        red_amps = red_model(pattern[None])[0]
        green_amps = green_model(pattern[None])[0]
        blue_amps = blue_model(pattern[None])[0]
        return rgb_amps_to_eff(red_amps, green_amps, blue_amps)

    # optimized_x, optimized_eff = run_gradient_ascent(
    #     target_function=predicted_total_eff,
    #     x_init=jax.random.uniform(
    #         jax.random.key(10),
    #         shape=(topology.n_geometrical_parameters,),
    #         minval=topology.minval / 2,
    #         maxval=topology.maxval / 2),
    #     learning_rate=1e-2,
    #     n_steps=300,
    #     boundary_projection_function=lambda x: jnp.clip(
    #         x, topology.minval, topology.maxval)
    # )

    # optimized_x = jnp.array([
    #     -0.0800529, 0.45483569, 0.63185313, -1., 0.56288739, 0.67036439, -0.48421222, 0.09203541, 0.12892259,
    #     0.18456246, 0.38888437, 0.0434736, 0.33688926, -0.47244639, 0.4533296, -0.31008412, -0.05100145, -0.13797899,
    #     0.64919403, 0.24416043, -0.07366039, -0.98692781, -0.98692781, 0.07534079, 0.41143237, 0.02563999, 0.17209216,
    #     -0.0690632, -0.33040641, -0.23041949, -0.00825904, 0.51399198, -0.19128155, -0.98775692, 0.65400124, 0.70581719,
    #     -0.15456085, -0.27181447, -0.76652032, 0.31758632, -0.71187813, 0.25213738, -0.56193931, 0.3986409, -0.23639103,
    #     0.1303658, 0.37974445, 0.29714265, 0.09786386, -0.31307759, -0.84142641, -0.33600212, -0.04167884, -0.4787766,
    #     0.07931624, -0.88184217, 0.50485479, -0.3005986, -0.4275907, 0.01185799, 0.2521995, 0.02623157, -0.33797191,
    #     0.23030376, 0.29818981, -0.59348689, -1., -1., 0.45417028, 0.97286864, -0.80631646, 0.37932028, -0.08039349,
    #     0.32268087, -0.32207571, 0.2518465, 0.35859357, 0.93326157, 0.93326157, 0.11657362, -0.07730419, 0.44510155,
    #     -0.91862452, 0.82638917, 0.80867754, 0.09507949, -0.97472234, 0.88610967, 0.60854167, -0.99750425, -0.60936314,
    #     0.15831748, -0.0361785, -0.75595572, 0.75595572, 0.56678756, 0.62964206, 0.13351505, 0.75139459, 0.59455755,
    #     0.26995709, -0.28679613, -0.05035265, -0.38057561, -0.12450327, -0.70212736, -0.1500511, 0.68079372, 0.21562216,
    #     0.74955013, 0.47325987, -0.06779923, 0.11157213, -0.37351904, 0.26818077, 0.05375535, 0.08402501, -0.44614261,
    #     0.34677553, 1., -1., -0.4786934, -0.47092616, -0.80549151, 0.98298695, 0.80549151, 0.26795531, 0.31481444,
    #     -0.47003689, 0.12322977, -0.59985123, -0.18658581, -0.27961649, -0.30791992, 0.50967697, -0.52072914,
    #     -0.33209239, 0.35035188, -0.08504505, 0.56949305, 0.25887023, 0.10325394, -0.01210789, -0.50621638, 0.09890142,
    #     -0.01830818, 0.39097926, 0.14417946, 0.18554904, 0.31759964, -0.31488322, 0.76501564, -0.05414304, 0.29440838,
    #     -0.43986907, -0.58926443, 0.47521679
    # ])
    # optimized_x = jnp.array([
    #     -0.01777149, 0.02329851, 0.11428079, 0.99475336, 0.47448091, -0.56755518, -0.08843149, 0.56042843, 1., 1.,
    #     -0.24987617, 0.16856832, -0.04163425, 0.09233659, 0.17268584, -0.58784992, -0.29292144, 0.09975055, 0.23188073,
    #     0.15046093, 0.73492011, 1., -0.8128909, -0.0562062, 1., -0.43043632, -0.12763542, -0.03732749, -0.18801739,
    #     -0.06509772, -0.53810388, -0.61498737, -0.49263295, -0.06204738, 0.44431993, 0.28418125, 0.25985991,
    #     0.18937216, 0.29663421, 0.30998494, 0.12881192, -0.07846701, -0.10366998, 0.14433512, 0.08794874, -0.07551098,
    #     0.00206894, -0.11818674, 0.6315574, -0.49418516, 0.41915119, -0.44198751, 0.9966289, -0.39989832, 0.9966289,
    #     -0.375241, 0.25867799, 0.36203053, 0.53379013, 0.25302367, 0.34833833, -0.64767686, -0.31717883, 0.33949966,
    #     0.75214225, 0.27909465, 0.26939428, -0.2694769, -0.38514053, 0.18141805, -0.59019016, -0.22156428, -0.47257033,
    #     0.06449708, -0.39479787, -0.69114966, -0.62075268, -0.5310882, -0.46839403, -0.14969511, 0.10402307,
    #     0.03535088, -0.0987719, -0.53724233, 0.39972808, 0.4986454, 0.41423716, -0.28449544, -0.41461601, -0.39869532,
    #     -0.0130377, 0.87792218, -0.56658174, 0.99324751, 0.37177625, 0.09168916, -0.2627431, -0.23899143, -0.78394084,
    #     0.22937875, -0.52410803, -0.14415744, -0.11293855, -0.21109196, 0.20989249, 0.26874832, 0.16407673, 0.49381374,
    #     -0.24193723, -0.08738705, -0.21324202, 0.74668119, -0.84515677, -0.20597955, -0.5667615, -0.56014028,
    #     -0.16215798, -0.32724174, -0.05152765, -0.6818574, 0.26541234, -0.2711568, 0.14061393, 0.03596955, 0.2711684,
    #     -0.39535778, -0.00861708, 0.40703554, -0.06298713, 0.10474863, -0.12287312, -0.03282294, -0.1951242,
    #     -0.27187988, 0.46224473, -0.24535741, 0.18912458, 0.16860354, -0.44986196, -0.53570303, -0.13988772,
    #     0.04449976, -0.23776413, 0.02141158, 0.2134676, -0.13009202, 0.41446329, -0.33622019, -0.02573756, -0.23485902,
    #     -0.34642662, -0.05474929, -0.15678451, 0.30727857, -0.06732228, 0.61905712, 0.9951514, -0.27937892,
    #     -0.21846983, -0.12645295, 0.53488444, 0.27375132, 0.12879378, -0.14870928, -0.26504809, 0.13646969, 0.68771367,
    #     -0.32341666, 0.99856016, -0.99856016, -0.14304715, 0.93541055, -0.9708551, -0.75607186, 0.77733701, 0.38776162,
    #     -0.45633722, 0.08574988, 0.14037622, -0.08096256, -0.6102216, 0.14157997, 0.28610604, 0.22141142, -0.04646001,
    #     -0.21349604, -0.07446929, -0.783473, 0.41721542, -0.10058097, 0.02795466, 0.28408608, -0.4249972, -0.05811436,
    #     -0.04823298, -0.10187699, -0.99460463, 0.99460463, 0.49018159, 0.31037669, 0.18092303, 0.25801604, -0.05130488,
    #     -0.83460091, 0.54848904, 0.75990856, -0.31403226, -0.3527811, -0.06372497, 0.08542937, 0.25453031, -0.88713852,
    #     0.09820476, -0.23308969, -0.2649373, 0.49468234, 0.62703418, -0.35962536, -0.35498848, 0.18871273, -0.16273776,
    #     0.24572378, -0.03280959, 0.52668046, 0.53101895, -0.50506259, -0.34106512, 0.20892632, 0.22202297, -0.3518161,
    #     0.17097921, -0.19364179, 0.37343848, 0.46335522, -0.13588052, -0.28612446, 0.1738975, 0.19322596, 0.00851931,
    #     -0.81495834, -0.84518226, 0.68016228, -1., 0.5279404, 0.80104826, 0.38315172, -0.03790204, 0.36605693,
    #     0.34769894, -0.60463295, -0.0673319, 0.14585989, 0.26214055, 0.50395009, -0.30393702, -0.43612858, 0.20890919,
    #     -0.18530217, -0.32041519, 0.60522549, 0.19428187, -0.43500681, 0.05605187, -0.09511931, 0.33757304, 0.0249994,
    #     -0.53415424, 0.63684144, -0.3954703, -0.01827427, 0.10343342, -0.22040778, -0.39632412, 0.18367602,
    #     -0.51486685, -0.36951036, 0.0260233, 0.29045996, 0.4318007, -0.56107713, -0.39736276, 0.04614699, -0.16066556,
    #     0.14289574, -0.12851547, 0.44687409, -0.51614677, 0.03193727, 0.450609, 0.66245989, -0.99936428, -0.18454593,
    #     -0.45133723, -0.70110891, 0.95875306, -0.01840474, 0.15154695, 0.03399564, -0.14717742, -0.03841998,
    #     0.34892601, 0.49984222, 0.25846519, -0.15529985, -0.20079608, 0.66900627, -0.18105501, -0.29501052, 0.3099968,
    #     -0.35399648, 0.10474985, 0.10235634, -0.45928212, 0.46553321, -0.61606249, 0.4930521, 0.48408323, 0.30821024,
    #     0.13276689, 0.38235978, 0.29244363, 0.39464365, 0.02876653, -0.14666653, -0.47524281, -0.10853319, -0.13699744,
    #     -0.11069804, 0.46782356, -0.47883192, 0.56202798
    # ])
    # optimized_x = jnp.array([
    #     -0.030754411, 0.0503778304, 0.14136011, 0.992650575, 0.472378125, -0.619712123, -0.174401021, 0.474458899, 1.0,
    #     1.0, -0.32203637, 0.0964081199, 0.0598106741, 0.193781514, 0.187426535, -0.537710432, -0.242781952, 0.172402325,
    #     0.304532505, 0.0348519615, 0.619311141, 0.922209973, -0.738108906, 0.0185757938, 0.922209973, -0.392631868,
    #     -0.0898309681, -0.000171697368, -0.183162513, -0.0602428429, -0.500948087, -0.637780957, -0.515426537,
    #     -0.102250051, 0.444689993, 0.304167745, 0.260229973, 0.209358655, 0.384815168, 0.0876049318, 0.216992878,
    #     -0.0715422042, -0.0967451742, -0.0780448882, 0.163090047, -0.137269365, -0.0596894449, -0.0430454329,
    #     0.615256453, -0.424640902, 0.402850243, -0.372443252, 0.842127685, -0.3714541, 0.842127685, -0.626158861,
    #     0.388340348, 0.111112669, 0.663452488, 0.389105173, 0.484419833, -0.720780639, -0.390282609, 0.281677749,
    #     0.694320339, 0.150868967, 0.57274621, -0.397702583, -0.0817886, 0.00334152536, -0.768266685, -0.277936803,
    #     -0.528942853, 0.0324554114, -0.426839539, -0.67579911, -0.60540213, -0.397679903, -0.334985733, -0.227957379,
    #     0.012367972, 0.0135976455, 0.090677499, -0.628897428, 0.321465811, 0.476892166, 0.285411581, -0.239946744,
    #     -0.370067314, -0.527520899, 0.0288670326, 0.851048325, -0.524677007, 0.961474312, 0.540596746, 0.128764652,
    #     -0.225667608, -0.0701709337, -0.651282419, 0.0924217268, -0.391449609, -0.281114463, -0.18379586, -0.28194927,
    #     0.274354138, 0.202619952, 0.185611531, 0.515348541, -0.214450468, -0.0599002879, -0.148780372, 0.680552822,
    #     -0.861039957, -0.325922707, -0.686704657, -0.576023467, -0.173530163, -0.334356307, -0.0586422169, -0.628442141,
    #     0.267949668, -0.217741541, 0.143151258, 0.121400959, 0.282391162, -0.309926371, 0.00260568234, 0.41828596,
    #     -0.288275265, -0.120539505, -0.1116227, -0.0326681036, -0.194969364, -0.326959188, 0.307357253, -0.400244887,
    #     0.134045272, 0.214672137, -0.343487355, -0.429328425, -0.145086069, 0.0393014109, -0.191695533, 0.236429651,
    #     0.428485671, -0.0734340666, 0.540170645, -0.210512835, 0.0309203934, -0.17969949, -0.34986284, -0.0581855103,
    #     -0.10162498, 0.400707926, 0.0261070756, 0.611369994, 0.982312884, -0.301222534, -0.192885515, -0.148296564,
    #     0.522581811, 0.261448691, 0.156372529, -0.0732928583, -0.189631668, 0.164048439, 0.470306846, -0.106009836,
    #     0.933646471, -0.933646471, -0.14304715, 0.919605446, -0.955049996, -0.940302958, 0.961568108, 0.424489274,
    #     -0.493064874, 0.184256963, 0.041869137, -0.08096256, -0.581367243, 0.112725613, 0.241875247, 0.265642213,
    #     -0.0133430968, -0.246612953, -0.085609189, -0.882606535, 0.516348955, -0.089441071, 0.0717945029, 0.240246237,
    #     -0.506643287, -0.0288724173, -0.0774749227, -0.0202309034, -0.997193484, 0.997193484, 0.49018159, 0.220448956,
    #     0.130603475, 0.347943774, -0.000985324673, -0.929412472, 0.636256055, 0.854720122, -0.288884271, -0.377929089,
    #     -0.151491985, 0.0538929005, 0.259845011, -0.892453221, 0.12974123, -0.219552847, 0.0467088379, 0.481145497,
    #     0.315388042, -0.297696471, -0.35498848, 0.126783841, -0.0972683694, 0.126706455, -0.0982789806, 0.645697785,
    #     0.530773655, -0.504817295, -0.272688453, 0.140549653, 0.43861568, -0.56840881, 0.270436093, -0.124459697,
    #     0.273981597, 0.394173127, -0.132152883, -0.289852097, 0.181085787, 0.186037673, 0.0223311408, -0.828770171,
    #     -0.84228427, 0.67726429, -0.998383314, 0.58148099, 0.965751354, 0.349462948, 0.032202373, 0.36605693,
    #     0.381387712, -0.769336044, -0.137436313, 0.138193155, -0.0527514795, 0.81884212, -0.296270285, -0.456455873,
    #     0.0282956446, -0.164974877, -0.139801645, 0.798708664, 0.260233537, -0.500958477, -0.137431304, -0.0975063252,
    #     0.267469023, 0.0273864152, -0.464050223, 0.602565033, -0.361193893, -0.0677239475, 0.140472974, -0.107496162,
    #     -0.509235738, 0.383034549, -0.714225379, -0.320060682, -0.0110162544, 0.281177153, 0.42018167, -0.5494581,
    #     -0.388079953, 0.04614699, -0.0610354949, 0.0432656749, -0.0593193396, 0.453574619, -0.5853429, 0.0252367415,
    #     0.386456555, 0.626789925, -0.925847653, -0.148875965, -0.498905285, -0.818695228, 0.999955466, 0.0291633145,
    #     0.139683656, 0.0458589337, -0.313633189, 0.120590259, 0.189915771, 0.666297989, 0.359636011, -0.0908008624,
    #     -0.265295068, 0.629514888, -0.141563628, -0.396181341, 0.359685415, -0.403685095, 0.208567189, 0.00348348238,
    #     -0.360409262, 0.361715871, -0.637337437, 0.526357148, 0.450778182, 0.329485187, 0.341416108, 0.173710562,
    #     0.265528089, 0.421559191, 0.148016101, -0.14666653, -0.594492381, -0.180579558, -0.0649510718, -0.132171268,
    #     0.526050006, -0.537058366, 0.583501208
    # ])
    # seed 91, rmax 7, after optimization with fno
    optimized_x = jnp.array([
        -4.11809619e-02, -8.35428389e-02, -2.02006287e-01, -6.26663685e-01, 9.99672399e-01, 6.11448446e-01,
        -2.04191481e-01, 2.76020153e-02, 3.38171279e-01, -8.07431767e-01, -2.64831436e-01, -4.32074780e-01,
        5.19126192e-01, -9.96538974e-01, 2.39184885e-02, -4.07291362e-02, -4.22569844e-01, 9.38178586e-03,
        7.06049146e-01, 8.94573215e-02, 3.09052290e-01, -2.37339251e-02, 1.01159969e-01, -9.25480116e-01,
        -9.91045615e-01, 7.66914938e-01, 2.81186240e-01, 1.20773042e-01, 3.05287849e-01, -1.47784565e-01,
        3.33129078e-01, 2.60752584e-01, -9.96518713e-01, -7.62235418e-01, -3.12371149e-01, 3.80250343e-01,
        5.08452863e-02, 7.36774830e-01, 5.17022070e-01, 3.31127416e-01, 7.82763441e-02, -2.26616913e-01, 1.86057150e-01,
        6.13674461e-02, -7.90081134e-01, -8.06468745e-02, -1.63008079e-01, 6.51102642e-02, 1.46590852e-01,
        -7.92037763e-02, -4.91079805e-01, -5.56475758e-01, 7.44479044e-01, -5.06290593e-02, 6.59986918e-01,
        -4.50800569e-01, 5.94008855e-01, -1.20305173e-01, -1.08936889e-01, -3.63350596e-01, 1.95462772e-01,
        -1.46679094e-01, -7.23501735e-02, 1.15226924e-01, 4.56067485e-01, 9.19871378e-03, -1.31476282e-01,
        -4.98488492e-02, 7.66587122e-03, 1.52949381e-01, -2.57154454e-01, 7.97311897e-01, 4.16887106e-03,
        4.54323217e-01, 5.11009253e-01, 9.57761640e-01, 3.50126019e-01, 1.75323790e-01, -9.13866672e-04, 1.29407780e-01,
        4.15001847e-01, 4.57966834e-01, -1.93120002e-01, 5.37201058e-01, -4.37289856e-02, -1.85897083e-02,
        -8.27004855e-01, 1.00000000e+00, 8.92817798e-01, -1.00000000e+00, 5.15116400e-01, 9.34536019e-02,
        -3.74002398e-01, -7.91776360e-01, 9.99734358e-01, -5.02406164e-02, -1.62433551e-01, 3.81401023e-01,
        -4.70437097e-02, 7.63792996e-01, -5.07632547e-01, -3.82384503e-01, 8.69045606e-02, 2.07127772e-01,
        1.86884829e-01, 1.26347489e-01, 2.11001814e-01, 2.48598779e-02, -5.78429498e-02, 1.97343240e-01, 3.14525258e-01,
        -4.62392460e-01, -4.78858532e-01, -8.37696958e-02, 6.99151080e-01, -9.16018758e-02, 6.94150339e-01,
        1.66487669e-01, 4.46205608e-02, 2.67066385e-01, -5.28741298e-01, -3.20287043e-01, -4.19640374e-03,
        -3.48898898e-01, -3.96780762e-01, -9.96675263e-02, 8.13175786e-01, 1.62316682e-02, -4.80749290e-01,
        -5.44794824e-02, -1.99918293e-01, -3.78255421e-01, 4.65010259e-02, -3.77433077e-01, 2.32190588e-01,
        -4.62119243e-01, 4.53346017e-01, -9.15466998e-01, 1.16971898e-01, -3.84848619e-01, 1.21917520e-02,
        2.65336790e-01, -2.81500659e-01, 5.79784628e-01, -1.03050577e-01, -4.99971074e-02, -5.02327491e-01,
        -3.09635007e-01, 4.56332323e-01, -6.66025138e-02, -7.64197286e-01, -7.96249773e-02, 4.06741779e-01,
        2.24511750e-01, 6.78159040e-02, 1.86478989e-01, 5.23891884e-01
    ])
    # r 5, seed 92
    # optimized_x = jnp.array([
    #     -1.85839547e-01, 2.38824288e-01, -3.92176745e-01, 3.95808767e-01, -4.46263209e-01, 5.72291802e-02,
    #     -2.28853264e-01, 1.21829377e-01, -3.30544728e-01, -3.71400775e-02, -4.43386187e-01, 4.30169170e-04,
    #     -2.02614925e-01, 1.59361717e-01, 6.56568822e-03, 2.58247145e-01, 1.08352141e-01, -3.69414322e-01,
    #     5.32303713e-02, -1.21556170e-01, 3.25066069e-02, -5.40637288e-02, 4.16240409e-01, 1.30713023e-01,
    #     -2.36960031e-02, 3.69351969e-01, 1.23832717e-01, -2.32530968e-01, 4.13153113e-01, -5.24186178e-01,
    #     6.05942719e-02, 8.55172993e-01, 1.49706924e-01, -3.63042165e-01, 2.04060143e-01, -1.63025895e-02,
    #     -1.43475739e-01, -2.82701771e-01, 6.98159946e-02, 6.18862306e-02, 4.28266142e-01, 2.93659604e-01,
    #     5.40243787e-01, -3.03771637e-01, 2.78487970e-01, -8.19242018e-02, 2.46333048e-01, 3.81883643e-01,
    #     1.24077950e-02, -7.41760836e-02, 6.70800284e-03, 8.77458421e-02, -6.87142137e-01, 1.50553510e-01,
    #     4.21971861e-01, 3.10997410e-01, -3.83032481e-01, 3.02857304e-01, 5.77453095e-01, -4.61923603e-01,
    #     2.84330023e-01, 1.63112653e-01, -4.05701868e-01, 4.66966084e-03, -4.43925474e-01, -3.32238372e-01,
    #     1.70609214e-02, -5.66501852e-02, 5.02745076e-01, -8.33020301e-02, -9.41062949e-02, -7.84694075e-02,
    #     3.42339089e-01, 1.25507913e-02, 6.63143340e-01, -5.92028487e-01, 7.35655597e-02, -1.11415691e-01,
    #     -2.51711666e-02, 4.64333082e-01, -2.61483622e-01, -9.68558180e-01, -6.18566306e-01, -1.59886627e-01,
    #     2.61829230e-01, -4.09692435e-02, 9.42137598e-01
    # ])
    optimized_x = optimized_x.at[1:].divide(2)

    def true_total_eff(x):
        pattern = topology(x, 100)
        red_amps = red_sim(pattern)
        green_amps = green_sim(pattern)
        blue_amps = blue_sim(pattern)
        return rgb_amps_to_eff(red_amps, green_amps, blue_amps)


    optimized_x, optimized_eff = run_gradient_ascent(
        target_function=true_total_eff,
        x_init=optimized_x,
        # x_init=jax.random.uniform(
        #     jax.random.key(91),
        #     shape=(topology.n_geometrical_parameters,),
        #     minval=topology.minval / 2,
        #     maxval=topology.maxval / 2),
        learning_rate=1e-3,
        n_steps=200,
        boundary_projection_function=lambda x: jnp.clip(
            x, topology.minval, topology.maxval),
        except_keyboard_interrupt=True
    )

    final_pattern = topology(optimized_x, 100)
    final_red_amps = red_sim(final_pattern)
    final_green_amps = green_sim(final_pattern)
    final_blue_amps = blue_sim(final_pattern)

    # final_true_eff = rgb_amps_to_eff(final_red_amps, final_green_amps, final_blue_amps)
    # print(final_true_eff)
    jnp.set_printoptions(linewidth=100000)
    print(repr(optimized_x))

    fig, ax = plt.subplots(2, 2)
    ax = ax.flatten()
    ax[0].imshow(final_pattern)

    for ax_i, wl, amps, expansion in zip(
            ax[1:], [650, 550, 450],
            [final_red_amps, final_green_amps, final_blue_amps],
            [red_expansion, green_expansion, blue_expansion]
    ):
        plot_amplitude_map(
            fig, ax_i,
            intensity_map_from_fourier_amplitudes(
                propagate_amps_in_free_space(
                    amps, 2500, expansion, wl, 2000),
                red_expansion, 100),
            wavelength_nm=wl)
    for ax_i in ax:
        ax_i.set_axis_off()
    plt.show()
